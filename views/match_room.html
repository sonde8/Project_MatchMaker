{% block content %}


<link rel="stylesheet" href="/css/match_room.css">
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

<nav id="navbar">
    <a href="/user/match"><img src="/img/logo1.png" alt="" class="main_logo"></a>
    <div class="user_info">
        <a href="/user/myPage">
            <ion-icon name="person-outline" class="user_logo"></ion-icon>
        </a>
        <a href="/user/logout">
            <ion-icon name="log-out-outline" class="logout_logo"></ion-icon>
        </a>
    </div>
</nav>

<div>
    <div class="content-container">
        <div class="matchfield-container">
            <img src="/img/matchfield.png" alt="" class="matchfield">
            {% set positions = ['st', 'lm', 'lcm', 'rcm', 'rm', 'lb', 'lcb', 'rcb', 'rb', 'gk'] %}
            {% for position in positions %}
            <div class="overlay-image {{ position }}">
                {% if balanceMatched %}
                {% if loop.index0 < teamA|length %} <img src="/img/player3.png" alt=""> <!-- AÌåÄ Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú -->
                    <div class="player-info">
                        <span>{{ teamA[loop.index0].user_id }}</span>
                        <br>
                        <span>{{ teamA[loop.index0].user_rate }}</span>
                        <br>
                        <span>{{ teamA[loop.index0].user_rank }}</span>
                    </div>
                    {% else %}
                    {% set indexB = loop.index0 - teamA|length %}
                    {% if indexB < teamB|length %} <img src="/img/gold8.png" alt=""> <!-- BÌåÄ Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú -->
                        <div class="player-info">
                            <span>{{ teamB[indexB].user_id }}</span>
                            <br>
                            <span>{{ teamB[indexB].user_rate }}</span>
                            <br>
                            <span>{{ teamB[indexB].user_rank }}</span>
                        </div>
                        {% endif %}
                        {% endif %}
                        {% else %}
                        {% if position in ['st', 'lm', 'lcm', 'rcm', 'rm'] %}
                        <img src="/img/player3.png" alt=""> <!-- ÏÉàÎ°úÏö¥ Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú -->
                        {% else %}
                        <img src="/img/gold8.png" alt="">
                        {% endif %}
                        {% if loop.index0 < join_users|length %} <div class="player-info">
                            <div class="profile_wrapper" id="profileImagesContainer">
                                <img id="profileImage" src="{{ user_photo[join_users[loop.index0]] }}" 
                                alt="Profile Image" class="profile_image circle"
                                onerror="this.onerror=null;this.src='/img/ball.png';">
                            </div>
                            <span>{{ user_nick[join_users[loop.index0]] }} {{ user_rate[join_users[loop.index0]] }}</span>
                            <span>{{ user_rank[join_users[loop.index0]] }}</span>
            </div>
            {% endif %}
            {% endif %}
        </div>
        {% endfor %}
    </div>


    <div class="info-container">
        <pre>Îß§Ïπò Ï†ïÎ≥¥</pre>
        <pre>{{ match.match_info }}</pre>
        <p>ÏßÄÏó≠: {{ match.match_region }}</p>
        <p>ÏòàÏÉÅ Í≤ΩÍ∏∞ ÎÇ†Ïßú: {{ match.match_date }}</p>
        <p>ÏòàÏÉÅ ÏãúÏûë ÏãúÍ∞Ñ: {{ match.match_st_dt }}</p>
        <p>ÏòàÏÉÅ Ï¢ÖÎ£å ÏãúÍ∞Ñ: {{ match.match_ed_dt }}</p>
        <p>Ïó¨ÏÑ±Î∂Ä Îß§Ïπò: {{ match.female_match_yn }}</p>
        <p>Ï†êÏàò Îß§Ïπò: {{ match.rate_match_yn }}</p>


        <div class="button-container">
            {% if idName != teamLeader %}
            <form action="/user/join_game" method="post" onsubmit="return checkUserLimit()">
                <input type="hidden" name="match_idx" value="{{ match.match_idx }}">
                <input type="submit" class="btn" value="Í≤ΩÍ∏∞Ï∞∏Í∞Ä" data-user-count="{{ join_users|length }}">
            </form>
            {% endif %}

            <form action="/user/cancel_game" method="post">
                <input type="hidden" name="match_idx" value="{{ match.match_idx }}">
                <input type="submit" class="btn" value="Í≤ΩÍ∏∞ÌÉàÌá¥">
            </form>

            {% if join_users.length == 10 %}
            <form action="/bal/tmmatch" method="post">
                <input type="hidden" name="match_title" value="{{ match.match_title }}">
                <input type="hidden" name="match_region" value="{{ match.match_region }}">
                <input type="hidden" name="match_date" value="{{ match.match_date }}">
                <input type="hidden" name="match_st_dt" value="{{ match.match_st_dt }}">
                <input type="hidden" name="match_ed_dt" value="{{ match.match_ed_dt }}">
                <input type="hidden" name="female_match_yn" value="{{ match.female_match_yn }}">
                <input type="hidden" name="rate_match_yn" value="{{ match.rate_match_yn }}">
                <input type="hidden" name="match_info" value="{{ match.match_info }}">
                <input type="hidden" name="match_idx" value="{{ match.match_idx }}">
                {% for join_user in join_users %}
                <input type="hidden" name="user_id" value="{{ join_user }}">
                <input type="hidden" name="user_rate" value="{{ user_info[join_user] }}">
                {% endfor %}
                <input type="hidden" name="idName" value="{{ idName }}"> <!-- idName Í∞í Ïú†ÏßÄ -->
                <input type="hidden" name="balanceMatched" value="true"> <!-- Î∞∏Îü∞Ïä§ Îß§Ïπ≠ ÏÉÅÌÉú -->
                <input type="submit" class="btn" value="Î∞∏Îü∞Ïä§ Îß§Ïπ≠"><br>
            </form>
            {% endif %}
        </div>
        <div>
            {% if teamA and teamA|length > 0 %}
            ÌåÄA (Average rate: {{ avgTeamA }})<br>
            {% for member in teamA %}
            <div style="border: 1px solid purple;">
                [{{ member.user_id }}, {{ member.user_rate }}]<br>
            </div>
            {% endfor %}
            {% endif %}
            <br>
            {% if teamB and teamB|length > 0 %}
            ÌåÄB (Average rate: {{ avgTeamB }})<br>
            {% for member in teamB %}
            <div style="border: 1px solid orange;">
                [{{ member.user_id }}, {{ member.user_rate }}]<br>
            </div>
            {% endfor %}
            {% endif %}

            {% if balanceMatched %}
            <br>
            <form action="/user/team" method="post">
                <input type="hidden" name="match_idx" value="{{ match.match_idx }}">
                <input type="hidden" name="teamA_user1" value="{{ teamA[0].user_id }}">
                <input type="hidden" name="teamA_user2" value="{{ teamA[1].user_id }}">
                <input type="hidden" name="teamA_user3" value="{{ teamA[2].user_id }}">
                <input type="hidden" name="teamA_user4" value="{{ teamA[3].user_id }}">
                <input type="hidden" name="teamA_user5" value="{{ teamA[4].user_id }}">
                <input type="hidden" name="teamB_user1" value="{{ teamB[0].user_id }}">
                <input type="hidden" name="teamB_user2" value="{{ teamB[1].user_id }}">
                <input type="hidden" name="teamB_user3" value="{{ teamB[2].user_id }}">
                <input type="hidden" name="teamB_user4" value="{{ teamB[3].user_id }}">
                <input type="hidden" name="teamB_user5" value="{{ teamB[4].user_id }}">

                <input type="submit" class="btn" value="ÌåÄÌôïÏ†ï">
            </form>

            <form action="/reserv/reservAll" method="get">
                <input type="hidden" name="match_idx" value="{{ match.match_idx }}">
                <a href="/reserv/reservAll"><input type="submit" class="btn" value="ÏòàÏïΩÌïòÍ∏∞"></a>
            </form>
            {% endif %}
            <!-- <div class="chatt">
                <input id="input" autocomplete="off" placeholder="Ï±ÑÌåÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" />
                <input id="chatBtn" type="button" class="btn" value="Ï†ÑÏÜ°" onclick="sendMessage()">
                <ul id="messages" style="list-style: none;"></ul>
                <span id="userNick" style="display: none;">{{ nick }}</span>
            </div> -->
            <div class="chat-container">
                <div class="chat-header">
                    <h3>üí¨Ï±ÑÌåÖÎ∞©</h3>
                </div>
                <div class="chat-messages">
                    <ul id="messages"></ul>
                </div>
                <div class="chat-input">
                    <input id="input" type="text" autocomplete="off" placeholder="Ï±ÑÌåÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" />
                    <button id="chatBtn" class="btn" onclick="sendMessage()">Ï†ÑÏÜ°</button>
                </div>
                <span id="userNick" style="display: none;">{{ nick }}</span>
            </div>
        </div>
    </div>
</div>



<!-- Ïä§ÌÅ¨Î¶ΩÌä∏ -->

<script>
    const matchIdxElement = document.getElementsByName("match_idx")[0];
    const matchIdxValue = matchIdxElement ? matchIdxElement.value : null;
    console.log('Match Index:', matchIdxValue);
    const now = new Date();
    const timestamp = now.toLocaleTimeString();



    function sendMessage() {
        const userNickElement = document.getElementById('userNick');
        const userNick = userNickElement.textContent;
        const input = document.getElementById('input');

        if (input.value) {
            if (ws.readyState === WebSocket.OPEN) {
                const now = new Date();
                const timestamp = now.toLocaleTimeString();

                const message = {
                    nick: userNick,
                    message: input.value,
                    timestamp: timestamp
                };

                ws.send(JSON.stringify(message));

                // ÏÑúÎ≤ÑÏóê Ï±ÑÌåÖ Î©îÏãúÏßÄ Ï†ÄÏû• ÏöîÏ≤≠
                fetch(`/match_room/${encodeURIComponent(matchIdxValue)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        timestamp: timestamp,
                        message: input.value,
                        match_idx: matchIdxValue
                    })
                })
                    .then(response => response.text())
                    .then(result => {
                        console.log('Message saved:', result);
                        input.value = '';
                    })
                    .catch(error => console.error('Error saving message:', error));
            } else {
                console.error('WebSocket is not open. ReadyState:', ws.readyState);
            }
        }
    }





    let ws;

    function connect() {
        const wsUrl = `ws://localhost:3007/match_room/${encodeURIComponent(matchIdxValue)}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
            console.log('Connected to the WebSocket server');
        };

        ws.onmessage = function (event) {
            const messageData = JSON.parse(event.data);
            const item = document.createElement('li');
            item.textContent = `[${messageData.timestamp}] ${messageData.nick}: ${messageData.message}`;
            document.getElementById('messages').appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        };
        ws.onclose = function () {
            console.log('WebSocket connection closed');
            // Reconnect attempt
            setTimeout(connect, 1000);
        };

        ws.onerror = function (error) {
            console.error('WebSocket error:', error);
        };
    }


    function loadMessages() {
        fetch(`/getMessages?match_idx=${encodeURIComponent(matchIdxValue)}`)
            .then(response => response.json())
            .then(data => {
                const messagesList = document.getElementById('messages');
                messagesList.innerHTML = ''; // Í∏∞Ï°¥ Î©îÏãúÏßÄ ÏÇ≠Ï†ú

                data.forEach(message => {
                    const item = document.createElement('li');
                    item.textContent = `[${message.timestamp}] ${message.nick}: ${message.message}`;
                    messagesList.appendChild(item);
                });

                window.scrollTo(0, document.body.scrollHeight);
            })
            .catch(error => console.error('Error fetching messages:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {


        connect();
        loadMessages();

        const inputField = document.getElementById('input');
        const chatBtn = document.getElementById('chatBtn');

        // ÏûÖÎ†• ÌïÑÎìúÏóêÏÑú Enter ÌÇ§Í∞Ä ÎàåÎ†∏ÏùÑ Îïå
        inputField.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Í∏∞Î≥∏ Enter ÎèôÏûë Î∞©ÏßÄ (Ìèº Ï†úÏ∂ú Îì±)
                sendMessage(); // sendMessage Ìï®Ïàò Ìò∏Ï∂ú
            }
        });
        var joinButton = document.getElementById("joinButton");
        // joinButton ÏöîÏÜå ÏÑ†ÌÉù
        var joinButton = document.querySelector('.btn'); // ÏòàÏãúÎ°ú .btn ÌÅ¥ÎûòÏä§ ÏÇ¨Ïö©

        // joinButtonÏù¥ Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
        if (joinButton) {
            // joinButtonÏù¥ Ï°¥Ïû¨Ìï† ÎïåÎßå data-user-count ÏÜçÏÑ± Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
            var userCount = joinButton.getAttribute("data-user-count");
            console.log(userCount);
        } else {
            console.error("joinButton ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
        }

        function checkUserLimit() {
            if (userCount >= 10) {
                alert("Ï∞∏Í∞Ä Ïù∏ÏõêÏù¥ Ïù¥ÎØ∏ 10Î™ÖÏùÑ Ï¥àÍ≥ºÌñàÏäµÎãàÎã§. Îçî Ïù¥ÏÉÅ Ï∞∏Í∞ÄÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
                return false;
            }
            return true;
        }

        if (userCount >= 10) {
            joinButton.disabled = true;
        }

        document.querySelector('form').onsubmit = checkUserLimit;
    });
    

</script>

{% endblock %}